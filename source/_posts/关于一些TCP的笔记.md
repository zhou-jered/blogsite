---
title: 关于TCP的一些笔记
date: 2017-07-20 20:37:35
tags: 
	- Note
	- TCP
	- Network
---


关于tcp连接之前有个很大的误解，我以为一旦tcp连接建立之后，网络的中间节点都会感知到这个连接的存在，并维护这条连接的相关信息，而且一直想不明白中间的节点设备有这么多的内存去存储每个经过这条节点的数据吗23333.
后来看完《tcp/ip详解》之后，对tcp连接的理解比较正确了。其实所谓的tcp连接就是两台主机之间维护的数据传送上下文（context）信息，比如数据偏移量offset，对方的缓冲区大小，彼此的接收状态（打开或者关闭）等等，这个连接更多的是逻辑上的概念。举例一种情况就比较好理解这个概念了，假设在两个主机之间已经建立好了一条连接，此时双方的数据已经传输到一个段落，没有数据要传输了，也没有发送关闭的数据包给彼此，此时双方都维护着这条连接的相关信息，但是并没有数据在这条连接上发送，如果一个主机突然宕机（比如断电）的话，另一主机是不会知道，假设tcp有恢复机制的话，宕掉的主机重启之后，恢复之前的tcp连接信息，是还可以继续传输数据的，可惜并没有这样的机制（据我所知并没有），如果这个宕机的主机重启之后，如果另外一台主机给它发送数据的话，此时会收到一个reset回复，此时连接被异常关闭掉。

## 关于握手建立连接
正常情况下，建立连接需要三次握手，由于TCP是全双工的通信协议，双方都必须知道对方是正常工作的，假设通信双方是A和B，A想要知道B正常工作，就必须询问一次和接收回答一次，同时B为了知道A能正常工作，也需要询问回答一次。双方的通信次数加起来就需要四次握手，但是由于在B回答A的询问时，可以带上自己的询问，两次通信合并为一次，就变成了三次握手。但是双方同时发起连接请求，同时向对方发送第一次握手请求SYNC的时候，此时前面提到的回答和询问合并的情况就不存在了，此时握手就需要四次。


## 最大报文长度
表示TCP传往另一端的最大数据块长度，这个可以在也只能在SYN报文中协商，默认为536字节，536字节数据 + 20 字节tcp头部 + 20字节ip头部 = 576 ip数据报。
这个值当然越大，传输的效率就越高，当然这个结论是有前提的， 最大的前提就是保证在更底层的网络协议中，不会发生数据包拆分的操作，如果这个值超过了某个网络的mtu，那么这个数据包就会被拆分依次发送之后重新组装，这个时候就说不好对效率的影响了，如果网络稳定性不好，被拆分之后的小包发生丢失或者错误，那么整个tcp数据包都要重传。

## 2MSL 等待状态
MSL: Maximum Segment Lifetime 任何报文网络最长的生存时间，实际上报文在网络的生存时间是按照跳数来计算生存时间。
在实际应用中的处理原则是，当TCP主动关闭一个连接的时候，该连接必须在TIME_WAIT状态等待2MSL时间，这样一个结果就是，在这段时间内，这个端口是不能用的，但是某些API提供来SO_REUSE参数来避开这个限制。
在处于TIME_WAIT状态中的接收的到报文都会被丢弃。


