---
title: 在VIPKID 工作
date: 2018-08-04 00:17:48
tags:
	- Daily
---

## 初到北京
今年2月从LINE离职，结束了在大连两年的生活，想到这里不得不说一句，在大连生活真的是舒服，但是职业发展实在是非常有限，所以还是来到了北京。三天面了6个公司，因为自己工作经验只有两年，本来想去大厂的，找同学内推了几次，都是因为工作年限建立被拒了，加上简历上好像也没有啥亮眼的地方，被拒了了也没啥可说的。在boss上联系了6家公司，面试时间被安排在三天内，每天早上下午各一场，讲道理，面试也是有套路的，不过这个套路也是我在面试第一天之后才领悟出来的。第一天面的莫名其妙之后，后面的就几家就比较顺利了，印象比较深刻的有三家公司：公司A，十分过分的问我进程和线程的区别；另外一家新橙科技，在一家博物馆里，做律所软件iCourt的，面试官给我感觉都挺不错的，约我来面试的面试官我也听喜欢他的，很随和。面试过程问得挺多的，sql是我软肋，被问出来了有点挫2333。最后hr面的时候，4A 腔，说话不明说，很蛋疼。我要薪水高了，你直接跟我说你技术水平达不到不就可以了，hr硬是绕大个圈子，好几句话把这个意思表达出来。最后还是没去，去了VIPKID，也就是我现在的公司。还是看中业务了吧，VIPKID做在线教育。其实iCourt也很不错的，主要是hr给我印象不太好，VIPKID的hr明显更接地气一点。也不知道iCourt 最近发展的怎样了，应该还不错吧。祝福下。

## 在VIPKID
VIPKID发展到现在差不多快一万人了，不过感觉还是个草台班子，基础设施跟我在LINE的时候完全没法比，不过也可以理解，vk技术人员一千人不到。vk的测试和运维存在感很严重，服务器是测试和运维在管着，我们开发就只有登录看日志的权限，而且开发服务器的数量还很少，各个部门之间共享服务器环境，想要部署测试的时候，需要去跟测试协调服务器使用问题，这个问题让我一直蛋疼到现在。真的蛋疼，非常蛋疼，十分蛋疼。主要是我在LINE的时候，LINE有自己的云，服务器随便用的，想要多少有多少，向怎么折腾怎么折腾，甚至我还试了一把 sudo rm -rf / ， 服务器坏了forece stop 再销毁就OK了。在对比我现在在vk，都是泪，上次测试环境数据库想要加个索引，我屁颠屁颠连上数据库执行sql，发现没有权限，找运维，运维说你要加索引，你要问问服务器的负责人，他允许了才能加，然后我就去找人去了，然后别人怕出事担责任，让我发邮件，引入更多的人来确认，一天就过去了。在我看来，这些流程完全没卵用。职场老油条。

在vk工作蛋疼的地方很多，吐槽的地方可以吐三天三夜。不过好的地方也有，大家一起上线到深夜还是很快乐的。总的来说，自己部门内，甚至大部门内的交流沟通还是很顺畅的。

在VIPKID 内部，使用的是为服务架构，但是怎么说的呢，这个微服务架构用的不伦不类的，首先我们的微服务架构没有任何指导思想和实践原则，服务拆分只是做到业务层面的拆分，在技术上的拆分还是没有体现出微服务的任何优势出来。在具体的技术实践上面，大部门将业务拆分给小组之后，小组做完业务功能之后，给自己的服务搞个内网域名，然后再申请几台服务器，让运维在前面搞个Nginx做负载均衡，之后调用方还是通过传统的手写Http请求通过域名的方式来调用各个服务。还是比较传统的那套玩法，严格的来说甚至都不叫微服务，我觉得我们公司对于微服务的理解仅限于把业务拆分得足够细就能叫做微服务了。

这样做带来的缺点是显而易见的，首先调用链很长很长很长，根据我的观察，一般调用链平均长度是5层左右，多的7/8层，如果用户请求首先到达的服务称为第一层服务的话，我维护的服务处在用户调用链的第三层，往下调用一些其他服务，依赖内网的快速网络响应，响应时间大概50毫秒左右，还能接受，But，基本上所有服务都要依赖的一个核心数据库表服务，在业务高峰期会出现十分恐怖的延时，高达几秒，导致用户响应要么超时，要么十分缓慢，反正一到高峰期，警报就来了。在数据库层面，我司结构组搞了个数据库中间件，要求全公司接入，但是功能仅限于监控和做一些profile，连慢查询的报警都没有，我在某个已经离职了的不知名前辈搞的另外一个数据库监控平台看了下sql执行情况，Full Scan 的sql大把大把的都没人管。在这样的情况下，一旦出现问题，排查效率就不是很高效了，从问题表面的服务一层一层往下缕，一层一层的找人，最后定位发现是db问题。到后来再出现高延时问题就直接看db了。这是我们微服务调用链长导致维护和排查问题低效的问题。

上面的问题也不是没有解决方案，那就是完善严密的全链路监控，不过我司这点上上升空间还是挺大的。我司微服务的架构还有另外一个问题，服务拆分做得不够好，导致重复开发，我司服务的拆分首先按照部门拆分，部门内部再进一步的细分各个模块服务，问题就处在部门内部的模块拆分上，部门之间拆分由于业务交叉不大，拆分得比较彻底，部门内部的拆分水平就良莠不齐了。开发的时候，经常发现有类似的接口，对接的时候也发现兄弟部门的接口不止有一个接口可以用，参数还不一样。我还发现过兄弟部门会告诉你有的接口从库，有的接口走主库，你调用的时候注意点，调挂了你要负责QAQ。这样拆分上的问题容易导致开发低效。


## 对于数据的一个看法
不过对于数据层面我还是有点自己的思考，我司做的在线教育，数据就是一些课程信息，包括上课的时间，上课的双方信息，这些应该就是比较核心的数据了，这些核心数据有着明显的局部热点，对于每一天来说，哪些数据需要被访问都是可以预测到的，所以提升性能的一个非常有效的手段对数据做热点拆分，把热点数据单独存储。相比于我司现在所有数据都存在一个库中，这个性能提升不是一点半点，而且按照我司土豪的尿性，完全可以把每天的热点数据集中存储在内存中。下星期跟leader提一下这个解决方案，看能不能push下去，毕竟数据管理不在我们部门。





